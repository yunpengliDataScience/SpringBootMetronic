<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- Select the block having id as 'mainContent' here in this page and pass it as a parameter to the fragement named 'pageTemplate'
		 defined in pageTemplate.html under fragments folder. The content should show up as the main content. 
		 Since all styles, navigation, and page layout have been defined in the pageTemplate fragment, we only need to 
		 focus on the main content construction. In addtion, page specific css links and scripts can be added. 
	-->
<th:block
	th:replace="fragments/pageTemplate :: pageTemplate(title='Main Form', pageId='mainForm', pageSpecificCSSLinks=~{:: link}, pageSpecificScripts=~{::script}, content=~{:: #mainContent})">

	<link rel="stylesheet" type="text/css" th:href="@{/css/sampleStyle.css}" />

	<th:block id="mainContent">
		<div class="container mt-5">
			<h1>Main Form</h1>

			<!-- Main Form -->
			<form id="mainForm" th:action="@{/forms/submitMainForm}" th:object="${mainForm}" method="post">
				<!-- Main form field -->
				<div class="form-group">
					<label for="mainInput">Main Input</label>
					<input type="text" class="form-control" id="mainInput" name="mainInput"
						th:value="${mainForm.mainInput}" required>
				</div>

				<!-- Button to open modal window -->
				<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#subFormModal"
					id="addNew">
					Add Record
				</button>

				<!-- Table to show the records loaded from the backend and added dynamically -->
				<h3 class="mt-4">Sub Form Records</h3>
				<table class="table table-bordered" id="subFormTable">
					<thead>
						<tr>
							<th>Field 1</th>
							<th>Field 2</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						<!-- Loop through subFormList to render existing records -->
						<tr th:each="subForm, iterStat : ${mainForm.subFormList}">
							<td><input type="hidden" th:name="mainForm.subFormList[__${iterStat.index}__].field1" th:value="${mainForm.subFormList[__${iterStat.index}__].field1}"/>[[${subForm.field1}]]</td>
							<td><input type="hidden" th:name="mainForm.subFormList[__${iterStat.index}__].field2" th:value="${mainForm.subFormList[__${iterStat.index}__].field2}"/>[[${subForm.field2}]]</td>
							<td>
								<button type="button" class="btn btn-warning btn-sm edit-row">Edit</button>
								<button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
							</td>
						</tr>
					</tbody>
				</table>

				<!-- Main form submit -->
				<button type="submit" class="btn btn-success mt-3">Submit Form</button>
			</form>

			<!-- Modal window for sub form -->
			<div class="modal fade" id="subFormModal" tabindex="-1" role="dialog" aria-labelledby="subFormModalLabel"
				aria-hidden="true">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="subFormModalLabel">Sub Form</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<!-- Sub-form fields -->
							<div class="form-group">
								<label for="field1">Field 1</label>
								<input type="text" class="form-control" id="field1" required>
							</div>
							<div class="form-group">
								<label for="field2">Field 2</label>
								<input type="text" class="form-control" id="field2" required>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							<button type="button" id="saveSubForm" class="btn btn-primary">Save</button>
						</div>
					</div>
				</div>
			</div>
		</div>

	</th:block>

	<script>
		var editIndex = -1;

		$(document).ready(function () {
			// Save sub form data from modal
			$('#saveSubForm').on('click', function () {
				var field1 = $('#field1').val();
				var field2 = $('#field2').val();

				if (field1 && field2) {
					if (editIndex === -1) {
						// Add new row to the table
						var rowCount = $('#subFormTable tbody tr').length;
						var newRow = `<tr>
			                        <td><input type="hidden" name="subFormList[${rowCount}].field1" value="${field1}">${field1}</td>
			                        <td><input type="hidden" name="subFormList[${rowCount}].field2" value="${field2}">${field2}</td>
			                        <td>
			                            <button type="button" class="btn btn-warning btn-sm edit-row">Edit</button>
			                            <button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
			                        </td>
			                    </tr>`;

						$('#subFormTable tbody').append(newRow);
					} else {
						// Edit existing row
						var row = $('#subFormTable tbody tr').eq(editIndex);
						row.find('td:eq(0)').html(`<input type="hidden" name="subFormList[__${editIndex}__].field1" value="${field1}">${field1}`);
						row.find('td:eq(1)').html(`<input type="hidden" name="subFormList[__${editIndex}__].field2" value="${field2}">${field2}`);
						editIndex = -1;
					}

					// Clear the form and close the modal
					$('#field1').val('');
					$('#field2').val('');
					$('#subFormModal').modal('hide');
				}
			});

			// Delete row from table
			$(document).on('click', '.delete-row', function () {
				$(this).closest('tr').remove();
			});

			// Edit row in table
			$(document).on('click', '.edit-row', function () {
				var row = $(this).closest('tr');
				var field1 = row.find('td:eq(0)').text();
				var field2 = row.find('td:eq(1)').text();

				$('#field1').val(field1);
				$('#field2').val(field2);

				editIndex = row.index();
				$('#subFormModal').modal('show');
			});

			// Reset form for adding new record
			$('#addNew').on('click', function () {
				editIndex = -1;
				$('#field1').val('');
				$('#field2').val('');
			});
		});
	</script>
</th:block>

</html>